---
interface Props {
  pages: {
    [key: string]: string;
  };
}

const { pages } = Astro.props;
const pageKeys = Object.keys(pages);
---

<div class="flex h-screen">
  <!-- Left sidebar -->
  <div class="w-2xs bg-gray-900 text-white p-8 menu-container">
    <div class="space-y-0">
      {pageKeys.map((key, index) => (
        <button 
          class="menu-item w-full text-left p-4 hover:bg-gray-700 transition-colors text-3xl font-light"
          data-page={key}
          class:list={[{ active: index === 0 }]}
        >
          {key.charAt(0).toUpperCase() + key.slice(1)}
        </button>
      ))}
    </div>
  </div>

  <!-- Right content area -->
  <div class="flex-1 bg-white p-8 overflow-auto">
    <div id="content"></div>
  </div>
</div>

<script define:vars={{ pages }}>
  const menuItems = document.querySelectorAll('.menu-item');
  const contentDiv = document.getElementById('content');
  const menuContainer = document.querySelector('.menu-container');
  let selectedPage = Object.keys(pages)[0];

  // Improved Observer Logic
  let observer;
  function initScrollAnimations() {
    if (observer) observer.disconnect(); // Clean up old observer

    const elements = document.querySelectorAll(
      '.portfolio-image-left, .portfolio-image-right, .portfolio-text, .portfolio-section'
    );
    
    if (elements.length === 0) return;

    observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const el = entry.target;
          if (el.classList.contains('portfolio-image-left')) el.classList.add('animate-slide-in-left');
          else if (el.classList.contains('portfolio-image-right')) el.classList.add('animate-slide-in-right');
          else if (el.classList.contains('portfolio-text')) el.classList.add('animate-fade-in-up');
          else if (el.classList.contains('portfolio-section')) el.classList.add('animate-fade-in');
          
          observer.unobserve(el);
        }
      });
    }, { threshold: 0.05, rootMargin: '50px 0px 0px 0px' });

    elements.forEach(el => observer.observe(el));
  }

  // Helper to swap content and re-trigger animations
  function updateContent(pageKey) {
    contentDiv.innerHTML = pages[pageKey];
    requestAnimationFrame(() => {
      initScrollAnimations();
    });
  }

  // Click to select
  menuItems.forEach(item => {
    item.addEventListener('click', () => {
      menuItems.forEach(m => m.classList.remove('active'));
      item.classList.add('active');
      selectedPage = item.dataset.page;
      updateContent(selectedPage);
    });
  });

  // Hover to preview
  menuItems.forEach(item => {
    item.addEventListener('mouseenter', () => {
      const page = item.dataset.page;
      contentDiv.classList.add('fade-out');
      setTimeout(() => {
        updateContent(page);
        contentDiv.classList.remove('fade-out');
      }, 150);
    });
  });

  // Only revert when leaving the entire menu
  menuContainer.addEventListener('mouseleave', () => {
    contentDiv.classList.add('fade-out');
    setTimeout(() => {
      updateContent(selectedPage);
      contentDiv.classList.remove('fade-out');
    }, 150);
  });

  // Show default page
  updateContent(selectedPage);
</script>

<style>
  .menu-item {
    transition: background-color 0.2s;
  }

  .menu-item.active {
    background-color: rgb(55, 65, 81);
    border-left: 4px solid rgb(59, 130, 246);
  }

  #content {
    transition: opacity 0.15s ease-out;
  }

  #content.fade-out {
    opacity: 0;
  }

  /* Initial hidden state */
  .portfolio-image-left,
  .portfolio-image-right,
  .portfolio-text,
  .portfolio-section {
    opacity: 0;
  }

  @keyframes slideInLeft {
    from {
      opacity: 0;
      transform: translateX(-60px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(60px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .animate-slide-in-left {
    animation: slideInLeft 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  .animate-slide-in-right {
    animation: slideInRight 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  .animate-fade-in-up {
    animation: fadeInUp 0.8s ease-out forwards;
  }

  .animate-fade-in {
    animation: fadeIn 0.6s ease-out forwards;
  }

  .portfolio-image:nth-child(1) { animation-delay: 0s; }
  .portfolio-image:nth-child(2) { animation-delay: 0.15s; }
  .portfolio-image:nth-child(3) { animation-delay: 0.3s; }
  .portfolio-image:nth-child(4) { animation-delay: 0.45s; }
  .portfolio-image:nth-child(5) { animation-delay: 0.6s; }
</style>